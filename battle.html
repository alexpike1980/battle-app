<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Battle Details - FanShare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .option-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #374151;
    }
    
    .vs-circle {
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Progress Bar Styles */
    .progress-bar-container {
      display: flex;
      width: 100%;
      height: 40px;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
      position: relative;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .progress-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: width 0.3s ease;
    }
    
    .progress-blue {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    }
    
    .progress-green {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .progress-text {
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Site wrapper */
    .site-wrapper {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
    }

    /* Share Modal Styles */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      padding: 20px;
    }
    
    .share-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    /* Comments section */
    .comment-box {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      background: white;
    }
    
    .comment-author {
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }
    
    .comment-time {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    
    .comment-text {
      color: #4b5563;
      line-height: 1.5;
    }
  </style>
</head>

<body class="bg-white">
  <div class="site-wrapper">
    <!-- Header -->
    <header class="bg-white border-b">
      <div class="px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-blue-600">FANSHARE</h1>
        <button onclick="location.href='index.html'" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition font-medium">
          ‚Üê Back to Battles
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="bg-white py-6 px-4 min-h-[calc(100vh-80px)] flex gap-4">
      <div class="flex-1 max-w-[600px]">
        <!-- Battle Details -->
        <div id="battleDetail" class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <!-- Battle content will be loaded here -->
        </div>
        
        <!-- Comments Section -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <h2 class="text-xl font-bold mb-4">Comments</h2>
          
          <!-- Add Comment Form -->
          <div class="mb-6">
            <textarea 
              id="commentText" 
              placeholder="Share your thoughts..." 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
              rows="3"
            ></textarea>
            <div class="mt-3 flex gap-3">
              <input 
                type="text" 
                id="commentAuthor" 
                placeholder="Your name (optional)" 
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <button 
                onclick="postComment()" 
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-medium"
              >
                Post Comment
              </button>
            </div>
          </div>
          
          <!-- Comments List -->
          <div id="commentsList">
            <!-- Comments will be loaded here -->
          </div>
        </div>
      </div>
      
      <!-- Right Sidebar -->
      <aside class="hidden lg:block w-[280px] flex-shrink-0 border-l border-gray-200 pl-4">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
          <h3 class="text-lg font-semibold mb-4">üî• Trending Topics</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">#TechBattles</span>
              <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-full text-xs">124 battles</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">#MovieVsMovie</span>
              <span class="bg-green-100 text-green-600 px-2 py-1 rounded-full text-xs">89 battles</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">#FoodFight</span>
              <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded-full text-xs">67 battles</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">#SportsFace</span>
              <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-xs">45 battles</span>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-4 mt-4">
          <h3 class="text-lg font-semibold mb-4">üìä Battle Stats</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Total Votes</span>
              <span class="font-semibold text-sm" id="total-votes-sidebar">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Time Remaining</span>
              <span class="font-semibold text-green-600 text-sm" id="time-remaining-sidebar">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 text-sm">Comments</span>
              <span class="font-semibold text-sm" id="comments-count-sidebar">-</span>
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg border border-gray-200 p-4 mt-4 text-white">
          <h3 class="text-base font-semibold mb-2">üí° Share This Battle!</h3>
          <p class="text-blue-100 text-xs mb-3">Help your favorite win by sharing with friends.</p>
          <button onclick="document.getElementById('shareModal').style.display='flex'" class="w-full bg-white text-blue-600 py-2 px-3 rounded-lg hover:bg-blue-50 transition font-medium text-sm">
            Share Battle
          </button>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-4 mt-4">
          <h3 class="text-base font-semibold mb-3">üèÜ Related Battles</h3>
          <div id="related-battles" class="space-y-2">
            <!-- Related battles will be loaded here -->
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <h3 class="text-xl font-bold mb-4">üéâ Vote Recorded!</h3>
      <p class="text-gray-600 mb-6">Share this battle with your friends to get more votes!</p>
      
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="shareToTwitter()" class="flex items-center justify-center gap-2 bg-black text-white py-3 rounded-lg hover:bg-gray-800 transition">
          <span>ùïè</span>
          <span>Twitter</span>
        </button>
        <button onclick="shareToFacebook()" class="flex items-center justify-center gap-2 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
          <span>üìò</span>
          <span>Facebook</span>
        </button>
        <button onclick="shareToReddit()" class="flex items-center justify-center gap-2 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition">
          <span>üü†</span>
          <span>Reddit</span>
        </button>
        <button onclick="copyLink()" class="flex items-center justify-center gap-2 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition">
          <span>üîó</span>
          <span>Copy Link</span>
        </button>
      </div>
      
      <button onclick="closeShareModal()" class="mt-4 text-gray-500 hover:text-gray-700 transition">
        Close
      </button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://oleqibxqfwnvaorqgflp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sZXFpYnhxZndudmFvcnFnZmxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNjExMTQsImV4cCI6MjA2MTkzNzExNH0.AdpIio7ZnNpQRMeY_8Sb1bXqKpmYDeR7QYvAfnssdCA';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(location.search);
    const battleId = params.get('id');

    // Time calculation
    function calculateTimeLeft(endTime) {
      let diff = new Date(endTime) - new Date();
      if (diff <= 0) return '';
      const days = Math.floor(diff/86400000); diff %= 86400000;
      const hours = Math.floor(diff/3600000); diff %= 3600000;
      const minutes = Math.floor(diff/60000); diff %= 60000;
      const seconds = Math.floor(diff/1000);
      const parts = [];
      if (days) parts.push(`${days} day${days>1?'s':''}`);
      if (hours) parts.push(`${hours} hour${hours>1?'s':''}`);
      if (minutes) parts.push(`${minutes} min${minutes>1?'s':''}`);
      if (seconds) parts.push(`${seconds} sec${seconds>1?'s':''}`);
      return parts.join(' ');
    }

    function startLiveCountdown(id, endTime) {
      const el = document.getElementById(`timer-${id}`);
      function update() {
        const t = calculateTimeLeft(endTime);
        if (!t) { 
          el.textContent = 'Finished'; 
          clearInterval(interval); 
        } else { 
          el.textContent = `Time Left: ${t}`; 
        }
      }
      const interval = setInterval(update, 1000); 
      update();
    }

    // Render progress bar
    function renderProgressBar(v1 = 0, v2 = 0) {
      const total = v1 + v2;
      const p1 = total ? Math.round(v1/total * 100) : 50;
      const p2 = 100 - p1;
      
      return `
        <div class="progress-bar-container">
          <div class="progress-segment progress-blue ${p1 === 100 ? 'rounded-r-lg' : ''}" style="width: ${p1}%;">
            <span class="progress-text">${p1}%</span>
          </div>
          <div class="progress-segment progress-green ${p2 === 100 ? 'rounded-l-lg' : ''}" style="width: ${p2}%;">
            <span class="progress-text">${p2}%</span>
          </div>
        </div>
      `;
    }

    // Share functions
    window.shareToTwitter = () => {
      const url = encodeURIComponent(window.location.href);
      const text = encodeURIComponent('Check out this battle on FanShare!');
      window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
    };

    window.shareToFacebook = () => {
      const url = encodeURIComponent(window.location.href);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
    };

    window.shareToReddit = () => {
      const url = encodeURIComponent(window.location.href);
      const title = encodeURIComponent('Check out this battle on FanShare!');
      window.open(`https://www.reddit.com/submit?url=${url}&title=${title}`, '_blank');
    };

    window.copyLink = () => {
      navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
    };

    window.closeShareModal = () => {
      document.getElementById('shareModal').style.display = 'none';
    };

    // Vote function
    window.vote = async (battleId, option) => {
      const col = option === 'option1' ? 'votes1' : 'votes2';
      
      try {
        // Get current votes
        const { data: battle, error: fetchError } = await supabase
          .from('battles')
          .select(col)
          .eq('id', battleId)
          .single();
          
        if (fetchError) throw fetchError;
        
        // Update votes
        const newVotes = (battle[col] || 0) + 1;
        const { error: updateError } = await supabase
          .from('battles')
          .update({ [col]: newVotes })
          .eq('id', battleId);
          
        if (updateError) throw updateError;
        
        // Reload battle to show new votes
        await loadBattle();
        
        // Show share modal
        document.getElementById('shareModal').style.display = 'flex';
      } catch (err) {
        console.error('Error voting:', err);
        alert('Error recording vote. Please try again.');
      }
    };

    // Load battle details
    async function loadBattle() {
      if (!battleId) {
        document.getElementById('battleDetail').innerHTML = '<p class="text-center text-gray-500">No battle ID provided</p>';
        return;
      }
      
      try {
        const { data: battle, error } = await supabase
          .from('battles')
          .select('*')
          .eq('id', battleId)
          .single();
          
        if (error) throw error;
        
        const active = new Date(battle.ends_at) > new Date();
        
        document.getElementById('battleDetail').innerHTML = `
          <h1 class="text-2xl font-bold mb-6">${battle.title}</h1>
          
          <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 mb-6">
            <!-- Option 1 -->
            <div class="flex flex-col items-center flex-1 w-full">
              <img src="${battle.image1 || 'https://via.placeholder.com/300'}" 
                   alt="${battle.option1}" 
                   class="w-full h-48 md:h-56 object-cover rounded-lg mb-3">
              <h3 class="option-title mb-3">${battle.option1}</h3>
              <button onclick="vote('${battle.id}', 'option1')" 
                      class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium ${!active ? 'opacity-50 cursor-not-allowed' : ''}"
                      ${!active ? 'disabled' : ''}>
                Vote
              </button>
            </div>
            
            <!-- VS Circle -->
            <div class="vs-circle bg-white w-16 h-16 flex items-center justify-center text-xl font-bold my-4 md:my-0">
              VS
            </div>
            
            <!-- Option 2 -->
            <div class="flex flex-col items-center flex-1 w-full">
              <img src="${battle.image2 || 'https://via.placeholder.com/300'}" 
                   alt="${battle.option2}" 
                   class="w-full h-48 md:h-56 object-cover rounded-lg mb-3">
              <h3 class="option-title mb-3">${battle.option2}</h3>
              <button onclick="vote('${battle.id}', 'option2')" 
                      class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium ${!active ? 'opacity-50 cursor-not-allowed' : ''}"
                      ${!active ? 'disabled' : ''}>
                Vote
              </button>
            </div>
          </div>
          
          ${renderProgressBar(battle.votes1 || 0, battle.votes2 || 0)}
          
          <div id="timer-${battle.id}" class="text-center text-gray-500 mt-3">
            ${active ? `Time Left: ${calculateTimeLeft(battle.ends_at)}` : 'Finished'}
          </div>
        `;
        
        // Update sidebar stats
        const totalVotes = (battle.votes1 || 0) + (battle.votes2 || 0);
        document.getElementById('total-votes-sidebar').textContent = totalVotes;
        document.getElementById('time-remaining-sidebar').textContent = active ? calculateTimeLeft(battle.ends_at) : 'Finished';
        
        if (active) {
          startLiveCountdown(battle.id, battle.ends_at);
          // Also update sidebar timer
          setInterval(() => {
            document.getElementById('time-remaining-sidebar').textContent = calculateTimeLeft(battle.ends_at) || 'Finished';
          }, 1000);
        }
      } catch (err) {
        console.error('Error loading battle:', err);
        document.getElementById('battleDetail').innerHTML = '<p class="text-center text-red-500">Error loading battle details</p>';
      }
    }

    // Comments functionality
    window.postComment = async () => {
      const commentText = document.getElementById('commentText').value.trim();
      const commentAuthor = document.getElementById('commentAuthor').value.trim() || 'Anonymous';
      
      if (!commentText) {
        alert('Please enter a comment');
        return;
      }
      
      try {
        const { error } = await supabase
          .from('comments')
          .insert([{
            battle_id: battleId,
            author: commentAuthor,
            text: commentText,
            created_at: new Date().toISOString()
          }]);
          
        if (error) throw error;
        
        // Clear form
        document.getElementById('commentText').value = '';
        document.getElementById('commentAuthor').value = '';
        
        // Reload comments
        await loadComments();
      } catch (err) {
        console.error('Error posting comment:', err);
        alert('Error posting comment. Please try again.');
      }
    };

    async function loadComments() {
      try {
        const { data: comments, error } = await supabase
          .from('comments')
          .select('*')
          .eq('battle_id', battleId)
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        const commentsHtml = comments.length ? comments.map(comment => `
          <div class="comment-box">
            <div class="comment-author">${comment.author}</div>
            <div class="comment-time">${new Date(comment.created_at).toLocaleString()}</div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `).join('') : '<p class="text-gray-500 text-center">No comments yet. Be the first to comment!</p>';
        
        document.getElementById('commentsList').innerHTML = commentsHtml;
        
        // Update comments count in sidebar
        document.getElementById('comments-count-sidebar').textContent = comments.length;
      } catch (err) {
        console.error('Error loading comments:', err);
        document.getElementById('commentsList').innerHTML = '<p class="text-red-500">Error loading comments</p>';
      }
    }

    // Load related battles
    async function loadRelatedBattles() {
      try {
        const { data: battles, error } = await supabase
          .from('battles')
          .select('id, title, votes1, votes2')
          .neq('id', battleId)
          .order('created_at', { ascending: false })
          .limit(3);
          
        if (error) throw error;
        
        const relatedHtml = battles.map(battle => {
          const totalVotes = (battle.votes1 || 0) + (battle.votes2 || 0);
          return `
            <a href="battle.html?id=${battle.id}" class="block p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
              <div class="font-medium text-sm text-gray-800 mb-1">${battle.title}</div>
              <div class="text-xs text-gray-500">${totalVotes} votes</div>
            </a>
          `;
        }).join('');
        
        document.getElementById('related-battles').innerHTML = relatedHtml || '<p class="text-sm text-gray-500">No related battles</p>';
      } catch (err) {
        console.error('Error loading related battles:', err);
      }
    }

    // Initialize
    loadBattle();
    loadComments();
    loadRelatedBattles();
  </script>
</body>
</html>
