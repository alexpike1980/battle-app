<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; background-color: #f8f9fa; }
    .container { max-width: 1200px; margin: auto; }

    /* Two-column grid: main + sidebar */
    .grid-cols-1\:lg\:\!grid-cols-4 { display: grid; grid-template-columns: 1fr; }
    @media(min-width:1024px) {
      .lg\:grid-cols-4 { grid-template-columns: repeat(4,1fr); }
      .lg\:col-span-3 { grid-column: span 3 / span 3; }
    }

    /* VS circle */
    .battle-images-wrapper { position: relative; display: flex; gap: 1rem; align-items: center; }
    .vs-circle {
      position: absolute; left:50%; top:35%; transform:translate(-50%,-50%);
      width:40px; height:40px; background:#fff; color:#000;
      border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-weight:bold; font-size:.9rem; z-index:2;
    }

    /* Option title clamp */
    .option-title {
      font-size: clamp(0.8rem,4vw,1.2rem);
      line-height:1.2; text-align:center; word-wrap:break-word;
      padding:.6em 0 .3em 0;
    }

    /* Modal common */
    .modal { position:fixed; top:0; left:0; width:100%;height:100%;
      background:rgba(0,0,0,.7); display:flex; align-items:center;justify-content:center;
      z-index:1000;
    }
    .modal.hidden { display:none!important; }
    .modal-content {
      background:#fff; padding:30px 20px; border-radius:12px;
      width:90%; max-width:500px; text-align:center; position:relative;
    }

    /* Share buttons */
    .share-buttons { display:flex; gap:15px; justify-content:center; flex-wrap:wrap; margin-bottom:20px; }
    .share-btn {
      display:flex; align-items:center; gap:10px; color:#fff;
      padding:12px 20px; border-radius:8px; text-decoration:none;
      font-weight:bold; width:140px; transition:background .2s,transform .2s;
    }
    .share-btn:hover { transform: translateY(-3px); filter:brightness(1.1); }
    .facebook { background:#4267B2; }
    .twitter  { background:#1DA1F2; }
    .reddit   { background:#FF4500; }
    .share-btn img { width:24px; height:24px; }

    /* Cancel */
    .cancel-btn { background:#6c757d; color:#fff; padding:12px 20px;
      border:none; border-radius:8px; cursor:pointer; transition:background .2s;
    }
    .cancel-btn:hover { background:#5a6268; }

    /* Progress bar */
    .progress-bar-container { display:flex; width:100%; background:#e9ecef;
      border-radius:12px; overflow:hidden; margin-bottom:16px; height:30px; }
    .progress-bar {
      display:flex; align-items:center; color:#fff; font-size:14px;
      line-height:30px; white-space:nowrap; padding:0 10px;
      flex-shrink:0; z-index:1;
    }
    .progress-bar.full { width:100%!important; border-radius:12px!important; }
    .progress-bar-blue  { background:#007bff; }
    .progress-bar-green { background:#28a745; }
    .text-left  { text-align:left; padding-left:10px; width:100%; }
    .text-right { text-align:right; padding-right:10px; width:100%; }
  </style>
</head>
<body>
  <div class="container p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Main content -->
    <div class="lg:col-span-3 space-y-6">
      <button onclick="location.href='index.html'" class="text-blue-500 hover:underline">
        &larr; Back to list
      </button>

      <div id="battleDetail"></div>

      <!-- Statistics section -->
      <section id="statistics" class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-2">Statistics</h2>
        <p class="text-gray-600">Loading stats…</p>
      </section>

      <!-- Comments section -->
      <section id="comments" class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-2">Comments</h2>
        <p class="text-gray-600">No comments yet.</p>
      </section>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="space-y-4">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-semibold mb-2">Widgets & Ads</h2>
        <p class="text-gray-600">Placeholder for ads/widgets</p>
      </div>
      <!-- more sidebar items… -->
    </aside>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="text-xl font-semibold mb-4">Make it count – share to vote!</h2>
      <div class="share-buttons">
        <a href="#" id="facebookShare" target="_blank" class="share-btn facebook">
          <img src="https://img.icons8.com/ios-filled/50/ffffff/facebook--v1.png" alt="Facebook"/>
          <span>Facebook</span>
        </a>
        <a href="#" id="twitterShare" target="_blank" class="share-btn twitter">
          <img src="https://oleqibxqfwnvaorqgflp.supabase.co/storage/v1/object/public/battle-images/x-social-media-white-icon.svg" alt="X.com"/>
          <span>X.com</span>
        </a>
        <a href="#" id="redditShare" target="_blank" class="share-btn reddit">
          <img src="https://img.icons8.com/ios-filled/50/ffffff/reddit.png" alt="Reddit"/>
          <span>Reddit</span>
        </a>
      </div>
      <button id="shareCloseBtn" class="cancel-btn">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL     = 'https://oleqibxqfwnvaorqgflp.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Utilities
    function calculateTimeLeft(endTime){
      let diff = new Date(endTime) - new Date();
      if(diff<=0) return '';
      const days    = Math.floor(diff/86400000); diff%=86400000;
      const hours   = Math.floor(diff/3600000);   diff%=3600000;
      const minutes = Math.floor(diff/60000);     diff%=60000;
      const seconds = Math.floor(diff/1000);
      const parts=[];
      if(days)    parts.push(`${days} day${days>1?'s':''}`);
      if(hours)   parts.push(`${hours} hour${hours>1?'s':''}`);
      if(minutes) parts.push(`${minutes} min${minutes>1?'s':''}`);
      if(seconds) parts.push(`${seconds} sec${seconds>1?'s':''}`);
      return parts.join(' ');
    }
    function startLiveCountdown(id,endTime){
      const el=document.getElementById(`timer-${id}`);
      function upd(){
        const t=calculateTimeLeft(endTime);
        if(!t){ el.textContent='Finished'; clearInterval(iv); }
        else{ el.textContent=`Time to Left: ${t}`; }
      }
      const iv=setInterval(upd,1000); upd();
    }
    function renderProgressBar(v1,v2){
      const total=v1+v2, p1=total?Math.round(v1/total*100):50, p2=100-p1;
      if(p1===100) return `<div class="progress-bar-container"><div class="progress-bar progress-bar-blue full"><span class="text-left">${v1} votes (100%)</span></div></div>`;
      if(p2===100) return `<div class="progress-bar-container"><div class="progress-bar progress-bar-green full"><span class="text-right">${v2} votes (100%)</span></div></div>`;
      return `<div class="progress-bar-container"><div class="progress-bar progress-bar-blue" style="width:${p1}%"><span class="text-left">${v1} (${p1}%)</span></div><div class="progress-bar progress-bar-green" style="width:${p2}%"><span class="text-right">${v2} (${p2}%)</span></div></div>`;
    }

    // Share modal logic
    function openShareModal(battleId, option){
      const m=document.getElementById('shareModal');
      m.classList.remove('hidden');
      const url=location.href, title='Make it count – share to vote!';
      document.getElementById('facebookShare').href= `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(title)}`;
      document.getElementById('twitterShare').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
      document.getElementById('redditShare').href  = `https://www.reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;

      // reset handlers
      document.querySelectorAll('#shareModal a').forEach(a=>{
        const c=a.cloneNode(true); a.replaceWith(c); a=c;
        c.onclick=async e=>{
          e.preventDefault();
          const col = option==='votes1'?'votes1':'votes2';
          const { data:row } = await supabase.from('battles').select(col).eq('id',battleId).single();
          const newV=(row[col]||0)+1;
          await supabase.from('battles').update({[col]:newV}).eq('id',battleId);
          await loadBattle();
          m.classList.add('hidden');
          window.open(c.href,'_blank');
        };
      });
    }

    // close share modal
    window.addEventListener('load',()=>{
      document.getElementById('shareCloseBtn').onclick = ()=> document.getElementById('shareModal').classList.add('hidden');
      document.getElementById('shareModal').onclick = e=> { if(e.target.id==='shareModal') e.target.classList.add('hidden'); };
    });

    // Load detail
    const params=new URLSearchParams(location.search),
          battleId=params.get('id');
    async function loadBattle(){
      if(!battleId){
        document.getElementById('battleDetail').innerText='No battle ID';
        return;
      }
      const { data:b, error }= await supabase.from('battles')
        .select('id,title,option1,option2,votes1,votes2,ends_at,image1,image2')
        .eq('id',battleId).single();
      if(error){
        document.getElementById('battleDetail').innerText=error.message;
        return;
      }
      const active=new Date(b.ends_at)>new Date();
      document.getElementById('battleDetail').innerHTML=`
        <h1 class="text-3xl font-bold mb-4">${b.title}</h1>
        <div class="battle-images-wrapper mb-4">
          <div class="flex-1 text-center">
            <img src="${b.image1}" class="mx-auto w-64 h-64 object-cover rounded"/>
            <div class="option-title">${b.option1}</div>
            <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded" onclick="openShareModal('${b.id}','votes1')">Vote</button>
          </div>
          <div class="vs-circle">VS</div>
          <div class="flex-1 text-center">
            <img src="${b.image2}" class="mx-auto w-64 h-64 object-cover rounded"/>
            <div class="option-title">${b.option2}</div>
            <button class="mt-2 bg-green-600 text-white px-4 py-2 rounded" onclick="openShareModal('${b.id}','votes2')">Vote</button>
          </div>
        </div>
        ${renderProgressBar(b.votes1,b.votes2)}
        <div id="timer-${b.id}" class="text-sm text-gray-600 mb-6">
          ${ active?`Time to Left: ${calculateTimeLeft(b.ends_at)}`:'Finished'}
        </div>
      `;
      if(active) startLiveCountdown(b.id,b.ends_at);
    }
    loadBattle();
  </script>
</body>
</html>
