<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .battle-images-wrapper {
      position: relative;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .vs-circle {
      position: absolute;
      left: 50%;
      top: 35%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      background: #fff;
      color: #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
      z-index: 2;
    }
    .option-title {
      font-size: clamp(0.8rem, 4vw, 1.2rem);
      line-height: 1.2;
      text-align: center;
      word-wrap: break-word;
      padding: 0.6em 0 0.3em 0;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Main content -->
    <div class="lg:col-span-3 space-y-6">
      <button onclick="location.href='index.html'"
              class="text-blue-500 hover:underline">&larr; Back to list</button>

      <div id="battleDetail"></div>

      <!-- Статистика -->
      <section id="statistics" class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-2">Statistics</h2>
        <!-- Здесь будет график, таблица и т.п. -->
        <p class="text-gray-600">Loading stats...</p>
      </section>

      <!-- Комментарии -->
      <section id="comments" class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-2">Comments</h2>
        <!-- Здесь будет форма + список комментариев -->
        <p class="text-gray-600">No comments yet.</p>
      </section>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="space-y-4">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-semibold mb-2">Widgets & Ads</h2>
        <!-- сюда позже можно вставить рекламу, виджеты и т.п. -->
        <p class="text-gray-600">Placeholder for ads/widgets</p>
      </div>
      <!-- можно добавить ещё блоки -->
    </aside>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal hidden">
    <div id="shareModalContent" class="modal-content">
      <h2 class="text-xl font-semibold mb-4">Make it count – share to vote!</h2>
      <div class="share-buttons mb-4">
        <a href="#" id="facebookShare" target="_blank" class="share-btn facebook">
          <img src="https://img.icons8.com/ios-filled/50/ffffff/facebook--v1.png" alt="Facebook"/>
          <span>Facebook</span>
        </a>
        <a href="#" id="twitterShare" target="_blank" class="share-btn twitter">
          <img src="https://oleqibxqfwnvaorqgflp.supabase.co/storage/v1/object/public/battle-images/x-social-media-white-icon.svg" alt="X"/>
          <span>X.com</span>
        </a>
        <a href="#" id="redditShare" target="_blank" class="share-btn reddit">
          <img src="https://img.icons8.com/ios-filled/50/ffffff/reddit.png" alt="Reddit"/>
          <span>Reddit</span>
        </a>
      </div>
      <button id="shareCloseBtn" class="cancel-btn">Cancel</button>
    </div>
  </div>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const SUPABASE_URL     = 'https://oleqibxqfwnvaorqgflp.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sZXFpYnhxZndudmFvcnFnZmxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNjExMTQsImV4cCI6MjA2MTkzNzExNH0.AdpIio7ZnNpQRMeY_8Sb1bXqKpmYDeR7QYvAfnssdCA';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Утилиты (скопировать из main.js)
  function calculateTimeLeft(endTime){ /* … */ }
  function startLiveCountdown(id,endTime){ /* … */ }
  function renderProgressBar(v1,v2){ /* … */ }
  function openShareModal(battleId,option){ /* … */ }

  // Парсим id из URL
  const params = new URLSearchParams(location.search),
        battleId = params.get('id');

  async function loadBattle(){
    if(!battleId){
      document.getElementById('battleDetail').innerText='No battle ID';
      return;
    }
    const { data:b, error } = await supabase
      .from('battles')
      .select('id,title,option1,option2,votes1,votes2,ends_at,image1,image2')
      .eq('id',battleId).single();
    if(error){
      document.getElementById('battleDetail').innerText=error.message;
      return;
    }

    const active = new Date(b.ends_at) > new Date();
    document.getElementById('battleDetail').innerHTML = `
      <h1 class="text-3xl font-bold mb-4">${b.title}</h1>
      <div class="battle-images-wrapper mb-4">
        <div class="flex-1 text-center">
          <img src="${b.image1}" class="mx-auto w-64 h-64 object-cover rounded"/>
          <div class="option-title">${b.option1}</div>
          <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded"
                  onclick="openShareModal('${b.id}','votes1')">Vote</button>
        </div>
        <div class="vs-circle">VS</div>
        <div class="flex-1 text-center">
          <img src="${b.image2}" class="mx-auto w-64 h-64 object-cover rounded"/>
          <div class="option-title">${b.option2}</div>
          <button class="mt-2 bg-green-600 text-white px-4 py-2 rounded"
                  onclick="openShareModal('${b.id}','votes2')">Vote</button>
        </div>
      </div>
      ${renderProgressBar(b.votes1,b.votes2)}
      <div id="timer-${b.id}" class="text-sm text-gray-600 mb-6">
        ${active?`Time to Left: ${calculateTimeLeft(b.ends_at)}`:'Finished'}
      </div>
    `;
    if(active) startLiveCountdown(b.id, b.ends_at);
  }
  loadBattle();

  // Закрытие share-модалки
  window.addEventListener('load', () => {
    document.getElementById('shareCloseBtn').onclick = () =>
      document.getElementById('shareModal').classList.add('hidden');
    document.getElementById('shareModal').onclick = e => {
      if (e.target.id==='shareModal')
        e.target.classList.add('hidden');
    };
  });
  </script>
</body>
</html>
